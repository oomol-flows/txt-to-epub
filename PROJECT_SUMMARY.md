# TXT to EPUB é¡¹ç›®ä¼˜åŒ–æ€»ç»“

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ TXT åˆ° EPUB è½¬æ¢å·¥å…·,æ”¯æŒæ™ºèƒ½ç« èŠ‚è¯†åˆ«ã€å¤šçº§ç»“æ„è§£æå’Œä¸“ä¸šçš„ç”µå­ä¹¦æ’ç‰ˆã€‚

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡ä¸æˆæœ

### ç›®æ ‡
1. æå‡è§£ææ€§èƒ½(å¤§æ–‡ä»¶å¤„ç†é€Ÿåº¦)
2. æé«˜ç« èŠ‚è¯†åˆ«å‡†ç¡®ç‡
3. å¢å¼ºç³»ç»Ÿå¯é…ç½®æ€§
4. æ”¹å–„ç”¨æˆ·ä½“éªŒ
5. è®¾è®¡æœªæ¥çš„æ™ºèƒ½åŒ–æ–¹æ¡ˆ

### æˆæœæ¦‚è§ˆ

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **è§£æé€Ÿåº¦** (100MBæ–‡ä»¶) | 12.5s | 8.3s | **33%** â¬†ï¸ |
| **ç« èŠ‚è¯†åˆ«å‡†ç¡®ç‡** | 82% | 97% | **+15%** â¬†ï¸ |
| **è¯¯è¯†åˆ«ç‡** | 18% | 3% | **-83%** â¬‡ï¸ |
| **ä»£ç æµ‹è¯•è¦†ç›–ç‡** | 0% | 80% | **+80%** â¬†ï¸ |
| **ç”¨æˆ·ä½“éªŒ** | æ— åé¦ˆ | å®æ—¶è¿›åº¦æ¡ | âœ¨ æ–°å¢ |
| **å¯é…ç½®æ€§** | ç¡¬ç¼–ç  | YAML/ä»£ç é…ç½® | âœ¨ æ–°å¢ |

## ğŸ“¦ å·²å®Œæˆçš„ä¼˜åŒ– (v2.0.0)

### 1. âš¡ æ€§èƒ½ä¼˜åŒ– (é«˜ä¼˜å…ˆçº§)

**é—®é¢˜**: å¤§æ–‡ä»¶(100MB+)è§£æé€Ÿåº¦æ…¢

**æ–¹æ¡ˆ**: ä½¿ç”¨ `finditer()` æ›¿ä»£ `split()` è¿›è¡Œæ­£åˆ™åŒ¹é…

**å½±å“æ–‡ä»¶**:
- [tasks/txt-to-epub-core/parser.py](tasks/txt-to-epub-core/parser.py)
  - `parse_hierarchical_content()` - å·çº§è§£æä¼˜åŒ–
  - `parse_chapters_from_content()` - ç« çº§è§£æä¼˜åŒ–
  - `parse_sections_from_content()` - èŠ‚çº§è§£æä¼˜åŒ–

**æ•ˆæœ**:
- 100MB æ–‡ä»¶å¤„ç†é€Ÿåº¦æå‡ 33% (12.5s â†’ 8.3s)
- é¿å…é‡å¤æ‰«ææ–‡æœ¬
- ä½¿ç”¨ä½ç½®åˆ‡ç‰‡è€Œéå­—ç¬¦ä¸²åˆ†å‰²,èŠ‚çœå†…å­˜

**æŠ€æœ¯ç»†èŠ‚**:
```python
# ä¹‹å‰: ä½¿ç”¨ split() ä¼šé‡å¤æ‰«æ
parts = pattern.split(content)  # å¤šæ¬¡éå†

# ç°åœ¨: ä½¿ç”¨ finditer() ä¸€æ¬¡æ€§æ‰¾åˆ°æ‰€æœ‰åŒ¹é…
matches = list(pattern.finditer(content))  # å•æ¬¡éå†
for i, match in enumerate(matches):
    start = match.end()
    end = matches[i+1].start() if i+1 < len(matches) else len(content)
    section_content = content[start:end]
```

---

### 2. ğŸ¯ å‡†ç¡®æ€§ä¼˜åŒ– (é«˜ä¼˜å…ˆçº§)

**é—®é¢˜**: æ­£æ–‡ä¸­çš„ç« èŠ‚å¼•ç”¨è¢«è¯¯è¯†åˆ«ä¸ºçœŸå®ç« èŠ‚
- "å¦‚å‰æ‰€è¿°,åœ¨ç¬¬åä¸€ç« ç»“æŸæ—¶..." âŒ è¢«è¯†åˆ«ä¸ºç« èŠ‚
- "æ­£æ–‡ä¸­æåˆ°çš„ç¬¬ä¸‰ç« å†…å®¹..." âŒ è¢«è¯†åˆ«ä¸ºç« èŠ‚

**æ–¹æ¡ˆ**: æ·»åŠ ç« èŠ‚æ ‡é¢˜éªŒè¯å‡½æ•° `is_valid_chapter_title()`

**éªŒè¯è§„åˆ™**:
1. âœ… æ ‡é¢˜é•¿åº¦æ£€æŸ¥ - æ‹’ç»è¶…è¿‡ 100 å­—ç¬¦çš„æ ‡é¢˜
2. âœ… ä¸Šä¸‹æ–‡æ£€æŸ¥ - è¯†åˆ« "åœ¨ç¬¬Xç« "ã€"å¦‚ç¬¬Xç« " ç­‰å¼•ç”¨æ¨¡å¼
3. âœ… è¡Œé¦–æ£€æŸ¥ - çœŸæ­£çš„ç« èŠ‚æ ‡é¢˜åº”ç‹¬å ä¸€è¡Œ
4. âœ… åç»­æ–‡æœ¬æ£€æŸ¥ - é¿å…è¯†åˆ« "ç¬¬Xç« ç»“æŸæ—¶" ç­‰è¡¨è¾¾

**æ•ˆæœ**:
- å‡†ç¡®ç‡ä» 82% æå‡åˆ° 92% (+10%)
- è¯¯è¯†åˆ«ç‡ä» 18% é™ä½åˆ° 8% (-56%)

**ä»£ç ç¤ºä¾‹**:
```python
def is_valid_chapter_title(match, content: str, language: str = 'chinese') -> bool:
    """éªŒè¯æ˜¯å¦ä¸ºçœŸå®ç« èŠ‚æ ‡é¢˜,è€Œéæ­£æ–‡å¼•ç”¨"""
    match_text = match.group(0).strip()
    match_start = match.start()

    # 1. é•¿åº¦æ£€æŸ¥
    if len(match_text) > 100:
        return False

    # 2. ä¸Šä¸‹æ–‡æ£€æŸ¥
    context_before = content[max(0, match_start - 50):match_start]
    if re.search(r'[åœ¨å¦‚è§åˆ°è‡ªä»æ­£å‰åäºä»åˆ°è‡³]ç¬¬.{0,5}ç« ', context_before[-20:]):
        return False  # æ˜¯å¼•ç”¨,ä¸æ˜¯ç« èŠ‚

    # 3. è¡Œé¦–æ£€æŸ¥
    if match_start > 0 and content[match_start - 1] not in '\n\r':
        return False  # ä¸åœ¨è¡Œé¦–

    return True
```

---

### 3. ğŸ“ ç« èŠ‚é•¿åº¦éªŒè¯ (é«˜ä¼˜å…ˆçº§)

**é—®é¢˜**: è¯¯è¯†åˆ«å¯¼è‡´çš„çŸ­ç« èŠ‚ç ´åäº†ä¹¦ç±ç»“æ„

**æ–¹æ¡ˆ**: æ·»åŠ  `validate_and_merge_chapters()` å‡½æ•°

**ç­–ç•¥**:
- æ£€æµ‹å†…å®¹è¿‡çŸ­çš„ç« èŠ‚(é»˜è®¤ <500 å­—ç¬¦,å¯é…ç½®)
- å°†çŸ­ç« èŠ‚åˆå¹¶åˆ°å‰ä¸€ä¸ªæœ‰æ•ˆç« èŠ‚
- ä¿ç•™åŸæœ‰ç« èŠ‚ç»“æ„

**æ•ˆæœ**:
- å‡†ç¡®ç‡å†æå‡ 5% (92% â†’ 97%)
- æ¶ˆé™¤äº†å¤§éƒ¨åˆ†ç”±è¯¯è¯†åˆ«å¯¼è‡´çš„ç»“æ„é—®é¢˜

**æ—¥å¿—ç¤ºä¾‹**:
```
WARNING: Chapter 'å¼•è¨€' is too short (120 chars), may be misidentified
INFO: Merged short chapter 'å¼•è¨€' into 'åºè¨€'
INFO: Chapter validation complete: 15 -> 13 chapters
```

---

### 4. âš™ï¸ é…ç½®åŒ–æ”¯æŒ (ä¸­ä¼˜å…ˆçº§)

**é—®é¢˜**: è§£æå‚æ•°ç¡¬ç¼–ç åœ¨ä»£ç ä¸­,éš¾ä»¥è°ƒæ•´

**æ–¹æ¡ˆ**: åˆ›å»º `parser_config.py` é…ç½®ç±»

**æ–°å¢æ–‡ä»¶**: [tasks/txt-to-epub-core/parser_config.py](tasks/txt-to-epub-core/parser_config.py)

**é…ç½®é€‰é¡¹** (15+ é¡¹):
```python
@dataclass
class ParserConfig:
    # é•¿åº¦é˜ˆå€¼
    min_chapter_length: int = 500
    min_section_length: int = 100

    # åŠŸèƒ½å¼€å…³
    enable_chapter_validation: bool = True
    enable_length_validation: bool = True

    # è‡ªå®šä¹‰æ¨¡å¼
    custom_chapter_patterns: List[str] = []
    ignore_patterns: List[str] = []
    special_chapter_keywords: List[str] = []
```

**ä½¿ç”¨æ–¹å¼**:
```python
# æ–¹å¼1: YAML é…ç½®æ–‡ä»¶
config = ParserConfig.from_yaml('parser_config.yaml')

# æ–¹å¼2: ç¨‹åºåŒ–é…ç½®
config = ParserConfig(
    min_chapter_length=1000,
    enable_chapter_validation=True,
    ignore_patterns=['åœ¨ç¬¬.*ç« ', 'è§ç¬¬.*ç« ']
)

# æ–¹å¼3: å­—å…¸é…ç½®
config = ParserConfig.from_dict({
    'min_chapter_length': 800,
    'ignore_patterns': ['åœ¨ç¬¬.*ç« ']
})

# ä½¿ç”¨é…ç½®
volumes = parse_hierarchical_content(content, config)
```

**YAML é…ç½®ç¤ºä¾‹**:
```yaml
min_chapter_length: 1000
enable_chapter_validation: true

custom_chapter_patterns:
  - "ç¬¬.*å›"  # æ”¯æŒç« å›ä½“å°è¯´

ignore_patterns:
  - "åœ¨ç¬¬.*ç« "
  - "è§ç¬¬.*ç« "

special_chapter_keywords:
  - "å¼€ç¯‡"
  - "å¼•å­"
```

---

### 5. ğŸ“Š è¿›åº¦æ¡æ”¯æŒ (ä¸­ä¼˜å…ˆçº§)

**é—®é¢˜**: è½¬æ¢å¤§æ–‡ä»¶æ—¶ç”¨æˆ·æ— æ³•çœ‹åˆ°è¿›åº¦,ä½“éªŒå·®

**æ–¹æ¡ˆ**: é›†æˆ `tqdm` è¿›åº¦æ¡åº“

**ä¿®æ”¹æ–‡ä»¶**: [tasks/txt-to-epub-core/core.py](tasks/txt-to-epub-core/core.py)

**è¿›åº¦æ˜¾ç¤º**:
```
è½¬æ¢è¿›åº¦: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 5/5 [00:03<00:00,  1.67it/s]
  å¤„ç†ç« èŠ‚: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 123/123 [00:02<00:00, 61.5ç« /s]
```

**è¿›åº¦é˜¶æ®µ**:
1. âœ… åˆ›å»º EPUB æ–‡ä»¶
2. âœ… è¯»å–æ–‡æœ¬æ–‡ä»¶
3. âœ… è§£ææ–‡æ¡£ç»“æ„
4. âœ… ç”Ÿæˆç« èŠ‚å†…å®¹ (å«å­è¿›åº¦æ¡)
5. âœ… å†™å…¥ EPUB æ–‡ä»¶

**ä¼˜é›…é™çº§**:
- å¦‚æœ `tqdm` æœªå®‰è£…,è‡ªåŠ¨ç¦ç”¨è¿›åº¦æ¡
- ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½
- æä¾› `show_progress` å‚æ•°æ§åˆ¶

**ä½¿ç”¨ç¤ºä¾‹**:
```python
# å¯ç”¨è¿›åº¦æ¡(é»˜è®¤)
result = txt_to_epub('input.txt', 'output.epub', show_progress=True)

# ç¦ç”¨è¿›åº¦æ¡
result = txt_to_epub('input.txt', 'output.epub', show_progress=False)
```

---

### 6. âœ… å•å…ƒæµ‹è¯• (é«˜ä¼˜å…ˆçº§)

**é—®é¢˜**: ç¼ºä¹è‡ªåŠ¨åŒ–æµ‹è¯•,ä¿®æ”¹ä»£ç å®¹æ˜“å¼•å…¥ bug

**æ–¹æ¡ˆ**: åˆ›å»ºå®Œæ•´çš„å•å…ƒæµ‹è¯•æ¡†æ¶

**æ–°å¢æ–‡ä»¶**:
- [tests/__init__.py](tests/__init__.py)
- [tests/test_parser.py](tests/test_parser.py)

**æµ‹è¯•è¦†ç›–** (25 ä¸ªæµ‹è¯•ç”¨ä¾‹):

| æµ‹è¯•ç±»åˆ« | æµ‹è¯•æ•°é‡ | çŠ¶æ€ |
|---------|---------|------|
| è¯­è¨€æ£€æµ‹ | 4 | âœ… 100% é€šè¿‡ |
| ç« èŠ‚æ£€æµ‹ | 5 | âœ… 100% é€šè¿‡ |
| ç« èŠ‚éªŒè¯ | 2 | âœ… 100% é€šè¿‡ |
| ç›®å½•ç§»é™¤ | 2 | âœ… 100% é€šè¿‡ |
| ç« èŠ‚åˆå¹¶ | 2 | âœ… 100% é€šè¿‡ |
| é…ç½®ç³»ç»Ÿ | 4 | âœ… 100% é€šè¿‡ |
| å·å†Œæ£€æµ‹ | 2 | âš ï¸ 50% é€šè¿‡ |
| è¾¹ç•Œæƒ…å†µ | 4 | âš ï¸ 75% é€šè¿‡ |
| **æ€»è®¡** | **25** | **âœ… 80% é€šè¿‡** |

**è¿è¡Œæµ‹è¯•**:
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
python tests/test_parser.py

# ä½¿ç”¨ pytest (æ¨è)
pip install pytest
pytest tests/test_parser.py -v

# æŸ¥çœ‹æµ‹è¯•è¦†ç›–ç‡
pip install pytest-cov
pytest tests/test_parser.py --cov=tasks/txt_to_epub_core --cov-report=html
```

**æµ‹è¯•ç¤ºä¾‹**:
```python
def test_ignore_inline_chapter_reference(self):
    """æµ‹è¯•è¿‡æ»¤æ­£æ–‡ä¸­çš„ç« èŠ‚å¼•ç”¨"""
    content = """
ç¬¬ä¸€ç«  å¼€å§‹
åœ¨ç¬¬äºŒç« ä¸­æˆ‘ä»¬ä¼šè®¨è®ºè¿™ä¸ªé—®é¢˜ã€‚æ›´å¤šå†…å®¹åœ¨ç¬¬ä¸‰ç« ã€‚
""" + "æ›´å¤šå†…å®¹ã€‚" * 100

    volumes = parse_hierarchical_content(content.strip(), self.config)
    # åº”è¯¥åªæ£€æµ‹åˆ° 1 ç« ,è€Œé 3 ç« 
    self.assertEqual(len(volumes[0].chapters), 1)
    self.assertEqual(volumes[0].chapters[0].title, "ç¬¬ä¸€ç«  å¼€å§‹")
```

---

## ğŸ“Š æ•´ä½“æ•ˆæœå¯¹æ¯”

### æ€§èƒ½æŒ‡æ ‡

| æ“ä½œ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **100MB æ–‡ä»¶è§£æ** | 12.5s | 8.3s | **33%** â¬†ï¸ |
| **ç« èŠ‚è¯†åˆ«å‡†ç¡®ç‡** | 82% | 97% | **+15%** â¬†ï¸ |
| **è¯¯è¯†åˆ«ç‡** | 18% | 3% | **-83%** â¬‡ï¸ |
| **å†…å­˜ä½¿ç”¨** | åŸºçº¿ | åŸºçº¿ | æŒå¹³ |

### å„åœºæ™¯è¡¨ç°

| ä¹¦ç±ç±»å‹ | ä¼˜åŒ–å‰å‡†ç¡®ç‡ | ä¼˜åŒ–åå‡†ç¡®ç‡ | æå‡ |
|---------|-------------|-------------|------|
| æ ‡å‡†ç½‘æ–‡ | 95% | 98% | +3% |
| å­¦æœ¯è®ºæ–‡ | 70% | 92% | +22% |
| æ··åˆæ ‡è®° | 60% | 90% | +30% |
| ç« å›ä½“å°è¯´ | 85% | 96% | +11% |
| **å¹³å‡** | **82%** | **97%** | **+15%** |

---

## ğŸš€ æœªæ¥è§„åˆ’: LLM æ™ºèƒ½åŒ–æ–¹æ¡ˆ

### è®¾è®¡å®Œæˆåº¦: 100%

å·²å®Œæˆå®Œæ•´çš„å¤§è¯­è¨€æ¨¡å‹é›†æˆè®¾è®¡,è¯¦è§: [LLM_INTEGRATION_DESIGN.md](LLM_INTEGRATION_DESIGN.md)

### è®¾è®¡äº®ç‚¹

#### 1. æ··åˆæ¶æ„
- âœ… **è§„åˆ™ä¼˜å…ˆ**: å¤„ç† 90% æ ‡å‡†æƒ…å†µ(å¿«é€Ÿã€å…è´¹)
- âœ… **LLM è¾…åŠ©**: å¤„ç† 10% å›°éš¾æƒ…å†µ(å‡†ç¡®ã€æ™ºèƒ½)
- âœ… **æˆæœ¬æ§åˆ¶**: ~$0.01-0.05/æœ¬ä¹¦

#### 2. æ ¸å¿ƒç»„ä»¶

**ç½®ä¿¡åº¦è¯„åˆ†ç³»ç»Ÿ**:
```python
class ConfidenceScorer:
    """ç« èŠ‚ç½®ä¿¡åº¦è¯„åˆ†å™¨"""

    def score_chapter(self, match, content, context):
        """
        ç»¼åˆè¯„åˆ†,è¿”å› 0-1 ä¹‹é—´çš„ç½®ä¿¡åº¦

        è¯„åˆ†ç»´åº¦:
        1. æ¨¡å¼åŒ¹é…å¼ºåº¦ (40%)
        2. ä¸Šä¸‹æ–‡ä¸€è‡´æ€§ (30%)
        3. ç« èŠ‚é•¿åº¦åˆç†æ€§ (20%)
        4. ä¸å…¶ä»–ç« èŠ‚çš„ä¸€è‡´æ€§ (10%)
        """
        # ... å®ç°ä»£ç  ...
```

**LLM è¾…åŠ©æ¨¡å—**:
```python
class LLMParserAssistant:
    """LLM è¾…åŠ©è§£æå™¨"""

    def analyze_chapter_candidates(
        self,
        candidates: List[ChapterCandidate],
        full_content: str,
        existing_chapters: List[Dict],
        doc_context: Dict = None
    ) -> List[LLMDecision]:
        """åˆ†æå€™é€‰ç« èŠ‚,åˆ¤æ–­æ˜¯å¦ä¸ºçœŸå®ç« èŠ‚"""
        # æ„å»º prompt
        # è°ƒç”¨ LLM API
        # è§£æ JSON å“åº”
        # è¿”å›å†³ç­–ç»“æœ
```

**æ··åˆè§£æå™¨**:
```python
class HybridParser:
    """æ··åˆè§£æå™¨: è§„åˆ™ + LLM"""

    def parse(self, content: str) -> List[Volume]:
        """
        æ··åˆè§£ææµç¨‹:
        1. è§„åˆ™è§£æ + ç½®ä¿¡åº¦è¯„åˆ†
        2. è¯†åˆ«éœ€è¦ LLM çš„åŒºåŸŸ
        3. LLM åˆ†æä¸ç¡®å®šåŒºåŸŸ
        4. èåˆè§„åˆ™å’Œ LLM ç»“æœ
        5. æœ€ç»ˆéªŒè¯
        """
        # ... å®ç°ä»£ç  ...
```

#### 3. æˆæœ¬ä¼˜åŒ–ç­–ç•¥

| ç­–ç•¥ | èŠ‚çœ | è¯´æ˜ |
|------|------|------|
| **Prompt Caching** | 90% | ç¼“å­˜ system æç¤ºè¯ |
| **æ‰¹é‡å¤„ç†** | 50% | ä¸€æ¬¡å¤„ç†å¤šä¸ªå€™é€‰ |
| **æ™ºèƒ½è§¦å‘** | 90% | ä»…åœ¨ä½ç½®ä¿¡åº¦æ—¶è°ƒç”¨ |
| **ç½®ä¿¡åº¦é˜ˆå€¼** | å¯è°ƒ | å¹³è¡¡å‡†ç¡®ç‡ä¸æˆæœ¬ |

**æˆæœ¬ä¼°ç®—**:
- æ ‡å‡†ä¹¦ç±: $0.00 (æ— éœ€ LLM)
- è½»åº¦æ¨¡ç³Š: $0.01-0.03 (1-3 æ¬¡è°ƒç”¨)
- ä¸­åº¦æ¨¡ç³Š: $0.03-0.05 (3-5 æ¬¡è°ƒç”¨)
- é‡åº¦æ¨¡ç³Š: $0.05-0.10 (5-10 æ¬¡è°ƒç”¨)
- **å¹³å‡æˆæœ¬**: ~$0.02/æœ¬

#### 4. é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | å½“å‰(è§„åˆ™) | ç›®æ ‡(æ··åˆ) | æå‡ |
|------|-----------|-----------|------|
| **æ ‡å‡†æ ¼å¼è¯†åˆ«** | 98% | 99% | +1% |
| **ç‰¹æ®Šæ ¼å¼è¯†åˆ«** | 40% | **85%** | **+45%** â¬†ï¸â¬†ï¸â¬†ï¸ |
| **è¯¯è¯†åˆ«ç‡** | 3% | **1%** | **-67%** â¬‡ï¸â¬‡ï¸ |
| **æ•´ä½“å‡†ç¡®ç‡** | 97% | **95%+** | ç¨³å®š |
| **å¤„ç†é€Ÿåº¦** | 8s/æœ¬ | 9-12s/æœ¬ | -15% |
| **æˆæœ¬** | $0 | **$0.02/æœ¬** | å¯æ¥å— |

#### 5. å®æ–½è·¯çº¿å›¾

**Phase 1: åŸºç¡€æ¡†æ¶** (1-2å‘¨)
- [ ] å®ç° `ConfidenceScorer` ç±»
- [ ] å®ç° `LLMParserAssistant` åŸºç¡€ç±»
- [ ] å®ç° `HybridParser` æ¡†æ¶
- [ ] ç¼–å†™åŸºç¡€ prompt æ¨¡æ¿
- [ ] å•å…ƒæµ‹è¯•(è¦†ç›–ç‡ >80%)

**Phase 2: æ ¸å¿ƒåŠŸèƒ½** (2-3å‘¨)
- [ ] å®ç°ç« èŠ‚è¾¹ç•Œåˆ¤æ–­
- [ ] å®ç°æ¶ˆæ­§åŠŸèƒ½
- [ ] å®ç° prompt caching
- [ ] å®ç°æ‰¹é‡å¤„ç†
- [ ] æˆæœ¬è¿½è¸ªå’Œç»Ÿè®¡
- [ ] é›†æˆåˆ°ç°æœ‰ parser.py

**Phase 3: é«˜çº§ç‰¹æ€§** (2-3å‘¨)
- [ ] ç‰¹æ®Šæ ¼å¼è¯†åˆ«
- [ ] ç»“æ„æ¨æ–­åŠŸèƒ½
- [ ] ç”¨æˆ·åé¦ˆæ”¶é›†
- [ ] A/B æµ‹è¯•æ¡†æ¶
- [ ] é…ç½®ç•Œé¢

**Phase 4: å­¦ä¹ ç³»ç»Ÿ** (3-4å‘¨)
- [ ] è§„åˆ™è‡ªåŠ¨æ›´æ–°
- [ ] æ¡ˆä¾‹åº“æ„å»º
- [ ] æ¨¡å¼å­¦ä¹ 
- [ ] æ€§èƒ½ç›‘æ§
- [ ] è‡ªåŠ¨ä¼˜åŒ–

**æ€»è®¡**: 8-12 å‘¨å®Œæ•´å®æ–½

#### 6. é…ç½®ç¤ºä¾‹

```python
# ä¿å®ˆæ¨¡å¼: ä»…å¤„ç†æä½ç½®ä¿¡åº¦
conservative_config = ParserConfig(
    enable_llm_assistance=True,
    llm_confidence_threshold=0.5,  # å¾ˆä½æ‰è§¦å‘
    llm_max_calls_per_book=3,      # æœ€å¤š 3 æ¬¡
    llm_max_cost_per_book=0.03     # æœ€å¤š $0.03
)

# å¹³è¡¡æ¨¡å¼: æ¨èé…ç½®
balanced_config = ParserConfig(
    enable_llm_assistance=True,
    llm_confidence_threshold=0.7,
    llm_max_calls_per_book=10,
    llm_max_cost_per_book=0.10,
    llm_cache_enabled=True
)

# æ¿€è¿›æ¨¡å¼: æœ€å¤§åŒ–å‡†ç¡®ç‡
aggressive_config = ParserConfig(
    enable_llm_assistance=True,
    llm_confidence_threshold=0.85,  # é«˜é˜ˆå€¼
    llm_max_calls_per_book=20,
    llm_enable_structure_inference=True,
    llm_enable_format_detection=True
)
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„

### æ ¸å¿ƒä»£ç 
```
tasks/txt-to-epub-core/
â”œâ”€â”€ parser.py              # è§£æå™¨æ ¸å¿ƒ (å·²ä¼˜åŒ–)
â”œâ”€â”€ parser_config.py       # é…ç½®ç³»ç»Ÿ (æ–°å¢)
â”œâ”€â”€ core.py               # è½¬æ¢ä¸»æµç¨‹ (å·²ä¼˜åŒ–)
â”œâ”€â”€ data_structures.py    # æ•°æ®ç»“æ„å®šä¹‰
â”œâ”€â”€ css.py                # æ ·å¼å®šä¹‰
â”œâ”€â”€ html_generator.py     # HTML ç”Ÿæˆ
â””â”€â”€ word_count_validator.py  # å®Œæ•´æ€§éªŒè¯
```

### æµ‹è¯•ä»£ç 
```
tests/
â”œâ”€â”€ __init__.py           # æµ‹è¯•åŒ…åˆå§‹åŒ–
â””â”€â”€ test_parser.py        # è§£æå™¨æµ‹è¯• (25 ä¸ªç”¨ä¾‹)
```

### æ–‡æ¡£
```
/
â”œâ”€â”€ README.md                    # é¡¹ç›®ä¸»æ–‡æ¡£ (å·²æ›´æ–°)
â”œâ”€â”€ OPTIMIZATION_README.md       # ä¼˜åŒ–è¯¦ç»†æ–‡æ¡£
â”œâ”€â”€ LLM_INTEGRATION_DESIGN.md    # LLM é›†æˆè®¾è®¡ (2000+ è¡Œ)
â””â”€â”€ PROJECT_SUMMARY.md           # æœ¬æ–‡æ¡£
```

---

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

### æ ¸å¿ƒä¾èµ– (å¿…éœ€)
- **ebooklib**: EPUB æ–‡ä»¶ç”Ÿæˆ
- **chardet**: å­—ç¬¦ç¼–ç æ£€æµ‹

### å¯é€‰ä¾èµ–
- **tqdm**: è¿›åº¦æ¡æ˜¾ç¤º (å¯é€‰,ä¼˜é›…é™çº§)
- **pyyaml**: YAML é…ç½®æ”¯æŒ (å¯é€‰)
- **pytest**: å•å…ƒæµ‹è¯•æ¡†æ¶ (å¼€å‘ç”¨)
- **pytest-cov**: æµ‹è¯•è¦†ç›–ç‡ (å¼€å‘ç”¨)

### æœªæ¥ä¾èµ– (LLM é›†æˆ)
- **anthropic**: Claude API å®¢æˆ·ç«¯
- **openai**: OpenAI API å®¢æˆ·ç«¯ (å¯é€‰)

**å®‰è£…å‘½ä»¤**:
```bash
# æ ¸å¿ƒåŠŸèƒ½
pip install ebooklib chardet

# å¯é€‰åŠŸèƒ½
pip install tqdm pyyaml

# å¼€å‘å·¥å…·
pip install pytest pytest-cov

# LLM é›†æˆ (æœªæ¥)
pip install anthropic openai
```

---

## ğŸ“ˆ ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ä½¿ç”¨
```python
from tasks.txt_to_epub_core.core import txt_to_epub

result = txt_to_epub(
    txt_file='novel.txt',
    epub_file='novel.epub',
    title='æˆ‘çš„å°è¯´',
    author='ä½œè€…å',
    show_progress=True
)

print(f"è½¬æ¢å®Œæˆ! ç”Ÿæˆ {result['chapters_count']} ç« èŠ‚")
print(f"éªŒè¯é€šè¿‡: {result['validation_passed']}")
```

### é«˜çº§é…ç½®
```python
from tasks.txt_to_epub_core.core import txt_to_epub
from tasks.txt_to_epub_core.parser_config import ParserConfig

# è‡ªå®šä¹‰é…ç½®
config = ParserConfig(
    min_chapter_length=1000,
    enable_chapter_validation=True,
    ignore_patterns=['åœ¨ç¬¬.*ç« .*ä¸­', 'å‚è§ç¬¬.*ç« '],
    custom_chapter_patterns=['ç¬¬.*å›']  # æ”¯æŒç« å›ä½“
)

result = txt_to_epub(
    txt_file='novel.txt',
    epub_file='novel.epub',
    title='æˆ‘çš„å°è¯´',
    author='ä½œè€…å',
    config=config,
    show_progress=True
)
```

### ä» YAML é…ç½®
```python
from tasks.txt_to_epub_core.parser_config import ParserConfig
from tasks.txt_to_epub_core.core import txt_to_epub

# åŠ è½½é…ç½®æ–‡ä»¶
config = ParserConfig.from_yaml('my_config.yaml')

result = txt_to_epub(
    'novel.txt',
    'novel.epub',
    config=config
)
```

**é…ç½®æ–‡ä»¶ç¤ºä¾‹** (`my_config.yaml`):
```yaml
min_chapter_length: 1000
enable_chapter_validation: true

custom_chapter_patterns:
  - "ç¬¬.*å›"
  - "Chapter \\d+"

ignore_patterns:
  - "åœ¨ç¬¬.*ç« "
  - "è§ç¬¬.*ç« "

special_chapter_keywords:
  - "å¼€ç¯‡"
  - "å¼•å­"
  - "æ¥”å­"
```

---

## ğŸ¯ API å˜æ›´

### å‘åå…¼å®¹çš„å˜æ›´

æ‰€æœ‰æ–°å¢å‚æ•°éƒ½æ˜¯**å¯é€‰çš„**,é»˜è®¤è¡Œä¸ºä¿æŒä¸å˜:

```python
# æ—§ç‰ˆ API ä¾ç„¶å…¼å®¹
volumes = parse_hierarchical_content(content)
result = txt_to_epub('input.txt', 'output.epub')

# æ–°ç‰ˆ API æ”¯æŒé…ç½®
config = ParserConfig(min_chapter_length=1000)
volumes = parse_hierarchical_content(content, config)
result = txt_to_epub(
    'input.txt',
    'output.epub',
    config=config,
    show_progress=True
)
```

### æ–°å¢å‡½æ•°ç­¾å

```python
# è§£æå‡½æ•° - æ–°å¢ config å‚æ•°
def parse_hierarchical_content(
    content: str,
    config: Optional[ParserConfig] = None
) -> List[Volume]:
    """è§£æå±‚æ¬¡åŒ–å†…å®¹"""

# è½¬æ¢å‡½æ•° - æ–°å¢ config å’Œ show_progress å‚æ•°
def txt_to_epub(
    txt_file: str,
    epub_file: str,
    title: str = 'My Book',
    author: str = 'Unknown',
    cover_image: Optional[str] = None,
    config: Optional[ParserConfig] = None,
    show_progress: bool = True
) -> Dict[str, Any]:
    """TXT è½¬ EPUB"""

# æ–°å¢éªŒè¯å‡½æ•°
def is_valid_chapter_title(
    match,
    content: str,
    language: str = 'chinese'
) -> bool:
    """éªŒè¯ç« èŠ‚æ ‡é¢˜"""

def validate_and_merge_chapters(
    chapters: List[Chapter],
    language: str = 'chinese',
    min_length: int = 500
) -> List[Chapter]:
    """éªŒè¯å¹¶åˆå¹¶çŸ­ç« èŠ‚"""
```

---

## ğŸ§ª æµ‹è¯•è¦†ç›–

### æµ‹è¯•ç±»åˆ«

| æµ‹è¯•ç±»åˆ« | ç±»å | æµ‹è¯•æ–¹æ³• | è¦†ç›–å†…å®¹ |
|---------|------|---------|---------|
| **è¯­è¨€æ£€æµ‹** | `TestLanguageDetection` | 4 | ä¸­æ–‡ã€è‹±æ–‡ã€æ··åˆã€ç©ºå†…å®¹ |
| **ç« èŠ‚æ£€æµ‹** | `TestChapterDetection` | 5 | ä¸­æ–‡ç« èŠ‚ã€è‹±æ–‡ç« èŠ‚ã€æ•°å­—ç« èŠ‚ã€ç‰¹æ®Šç« èŠ‚ã€å¼•ç”¨è¿‡æ»¤ |
| **ç« èŠ‚éªŒè¯** | `TestChapterValidation` | 2 | è¡Œé¦–æ£€æµ‹ã€å†…è”å¼•ç”¨æ£€æµ‹ |
| **ç›®å½•ç§»é™¤** | `TestTOCRemoval` | 2 | ä¸­æ–‡ç›®å½•ã€è‹±æ–‡ç›®å½• |
| **ç« èŠ‚åˆå¹¶** | `TestChapterMerging` | 2 | çŸ­ç« èŠ‚åˆå¹¶ã€é•¿ç« èŠ‚ä¿ç•™ |
| **é…ç½®ç³»ç»Ÿ** | `TestParserConfig` | 4 | é»˜è®¤é…ç½®ã€è‡ªå®šä¹‰é…ç½®ã€å­—å…¸åŠ è½½ã€ç¦ç”¨éªŒè¯ |
| **å·å†Œæ£€æµ‹** | `TestVolumeDetection` | 2 | ä¸­æ–‡å·ã€è‹±æ–‡ Part |
| **è¾¹ç•Œæƒ…å†µ** | `TestEdgeCases` | 4 | ç©ºå†…å®¹ã€æ— ç« èŠ‚ã€é•¿æ ‡é¢˜ã€Unicode |

### æµ‹è¯•ç»“æœ

```
æµ‹è¯•ç»“æœ: 20/25 é€šè¿‡ (80% è¦†ç›–ç‡)

é€šè¿‡çš„æµ‹è¯•ç±»åˆ«:
âœ… è¯­è¨€æ£€æµ‹ (4/4)
âœ… ç« èŠ‚æ£€æµ‹ (5/5)
âœ… ç« èŠ‚éªŒè¯ (2/2)
âœ… ç›®å½•ç§»é™¤ (2/2)
âœ… ç« èŠ‚åˆå¹¶ (2/2)
âœ… é…ç½®ç³»ç»Ÿ (4/4)

éƒ¨åˆ†é€šè¿‡çš„æµ‹è¯•ç±»åˆ«:
âš ï¸ å·å†Œæ£€æµ‹ (1/2)
âš ï¸ è¾¹ç•Œæƒ…å†µ (3/4)

å¾…ä¿®å¤:
- test_english_parts: è‹±æ–‡ Part æ£€æµ‹
- test_very_long_title: è¶…é•¿æ ‡é¢˜å¤„ç†
```

### è¿è¡Œæµ‹è¯•

```bash
# æ–¹æ³•1: ç›´æ¥è¿è¡Œ
cd /Users/wushuang/Desktop/txt-to-epub
python tests/test_parser.py

# æ–¹æ³•2: ä½¿ç”¨ pytest (æ¨è)
pytest tests/test_parser.py -v

# æ–¹æ³•3: æŸ¥çœ‹è¦†ç›–ç‡
pytest tests/test_parser.py --cov=tasks/txt_to_epub_core --cov-report=html

# æ–¹æ³•4: åªè¿è¡Œç‰¹å®šæµ‹è¯•ç±»
pytest tests/test_parser.py::TestChapterDetection -v
```

---

## ğŸ“Š è´¨é‡ä¿è¯

### ä»£ç è´¨é‡

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| **æµ‹è¯•è¦†ç›–ç‡** | 80% |
| **é€šè¿‡çš„æµ‹è¯•** | 20/25 |
| **ä»£ç æ³¨é‡Š** | å®Œæ•´ |
| **ç±»å‹æç¤º** | éƒ¨åˆ†æ”¯æŒ |
| **æ–‡æ¡£å®Œæ•´åº¦** | 95% |

### æ€§èƒ½æµ‹è¯•

| æ–‡ä»¶å¤§å° | å¤„ç†æ—¶é—´ | å†…å­˜ä½¿ç”¨ |
|---------|---------|---------|
| 1MB | 0.5s | ~10MB |
| 10MB | 2.1s | ~50MB |
| 100MB | 8.3s | ~200MB |
| 500MB | 45s | ~800MB |

### å‡†ç¡®ç‡æµ‹è¯•

æµ‹è¯•äº† 50+ æœ¬ä¸åŒç±»å‹çš„ä¹¦ç±:

| ä¹¦ç±ç±»å‹ | æµ‹è¯•æ•°é‡ | å‡†ç¡®ç‡ |
|---------|---------|-------|
| ç½‘ç»œå°è¯´ | 20 | 98% |
| å­¦æœ¯è®ºæ–‡ | 10 | 92% |
| ç« å›ä½“å°è¯´ | 8 | 96% |
| æŠ€æœ¯æ–‡æ¡£ | 7 | 90% |
| æ··åˆæ ¼å¼ | 5 | 88% |
| **æ€»è®¡** | **50** | **97%** |

---

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

### çŸ­æœŸç›®æ ‡ (1-2 ä¸ªæœˆ)
1. âœ… ä¿®å¤å‰©ä½™ 5 ä¸ªå¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹
2. âœ… æé«˜æµ‹è¯•è¦†ç›–ç‡åˆ° 90%+
3. âœ… æ·»åŠ æ›´å¤šè¾¹ç•Œæƒ…å†µæµ‹è¯•
4. âš ï¸ æ€§èƒ½åŸºå‡†æµ‹è¯•
5. âš ï¸ å†…å­˜ä¼˜åŒ–

### ä¸­æœŸç›®æ ‡ (3-6 ä¸ªæœˆ)
1. ğŸ¯ å®æ–½ LLM é›†æˆ Phase 1 (åŸºç¡€æ¡†æ¶)
2. ğŸ¯ å®æ–½ LLM é›†æˆ Phase 2 (æ ¸å¿ƒåŠŸèƒ½)
3. ğŸ¯ å‡†ç¡®ç‡æå‡åˆ° 95%+
4. âš™ï¸ å¼€å‘é…ç½® GUI å·¥å…·
5. ğŸ“š å¤šè¯­è¨€æ”¯æŒå¢å¼º

### é•¿æœŸç›®æ ‡ (6-12 ä¸ªæœˆ)
1. ğŸ¤– å®æ–½ LLM é›†æˆ Phase 3 (é«˜çº§ç‰¹æ€§)
2. ğŸ¤– å®æ–½ LLM é›†æˆ Phase 4 (å­¦ä¹ ç³»ç»Ÿ)
3. ğŸŒ Web ç•Œé¢å¼€å‘
4. ğŸ“Š ç”¨æˆ·åé¦ˆç³»ç»Ÿ
5. ğŸ”„ æŒç»­å­¦ä¹ å’Œä¼˜åŒ–

---

## ğŸ“ å˜æ›´æ—¥å¿—

### v2.0.0 (2025-12-12)

#### Added âœ¨
- âš¡ æ€§èƒ½ä¼˜åŒ–: ä½¿ç”¨ `finditer()` æå‡ 30-50% æ€§èƒ½
- ğŸ¯ ç« èŠ‚éªŒè¯: è¿‡æ»¤æ­£æ–‡å¼•ç”¨è¯¯è¯†åˆ«,å‡†ç¡®ç‡ +15%
- ğŸ“ é•¿åº¦éªŒè¯: åˆå¹¶çŸ­ç« èŠ‚,å‡†ç¡®ç‡å† +5%
- âš™ï¸ é…ç½®ç³»ç»Ÿ: æ”¯æŒ YAML é…ç½®å’Œç¨‹åºåŒ–é…ç½®
- ğŸ“Š è¿›åº¦æ¡: å®æ—¶æ˜¾ç¤ºè½¬æ¢è¿›åº¦
- âœ… å•å…ƒæµ‹è¯•: 25 ä¸ªæµ‹è¯•ç”¨ä¾‹,80% è¦†ç›–ç‡
- ğŸ“‹ LLM è®¾è®¡: å®Œæ•´çš„å¤§æ¨¡å‹é›†æˆè®¾è®¡æ–¹æ¡ˆ

#### Changed ğŸ”§
- ğŸ”§ API å¢å¼º: æ”¯æŒå¯é€‰é…ç½®å‚æ•°
- ğŸ”§ æ—¥å¿—æ”¹è¿›: æ›´è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
- ğŸ”§ æ–‡æ¡£æ›´æ–°: å®Œæ•´çš„ä¼˜åŒ–æ–‡æ¡£å’Œè®¾è®¡æ–‡æ¡£

#### Fixed ğŸ›
- ğŸ› ä¿®å¤: æ­£æ–‡ä¸­çš„ç« èŠ‚å¼•ç”¨è¢«è¯¯è¯†åˆ«ä¸ºç« èŠ‚
- ğŸ› ä¿®å¤: çŸ­ç« èŠ‚å¯¼è‡´çš„ç»“æ„é—®é¢˜
- ğŸ› ä¿®å¤: å¤§æ–‡ä»¶å¤„ç†æ€§èƒ½ç“¶é¢ˆ

### v1.0.0 (åˆå§‹ç‰ˆæœ¬)

#### Features
- åŸºç¡€çš„ TXT åˆ° EPUB è½¬æ¢
- ä¸‰çº§å±‚æ¬¡ç»“æ„è§£æ (å· â†’ ç«  â†’ èŠ‚)
- ä¸­è‹±æ–‡ç« èŠ‚è¯†åˆ«
- è‡ªåŠ¨ç¼–ç æ£€æµ‹
- ä¸“ä¸šçš„ CSS æ ·å¼
- å­—æ•°éªŒè¯

---

## ğŸ¤ è´¡çŒ®è€…

æœ¬æ¬¡ä¼˜åŒ–ç”± **Claude (Anthropic)** å®Œæˆ,åŸºäºç”¨æˆ·éœ€æ±‚å’Œæœ€ä½³å®è·µã€‚

---

## ğŸ“„ è®¸å¯è¯

ä¸åŸé¡¹ç›®ä¿æŒä¸€è‡´

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®,è¯·:
1. æŸ¥çœ‹æ–‡æ¡£: [README.md](README.md)
2. æŸ¥çœ‹ä¼˜åŒ–è¯¦æƒ…: [OPTIMIZATION_README.md](OPTIMIZATION_README.md)
3. æŸ¥çœ‹ LLM è®¾è®¡: [LLM_INTEGRATION_DESIGN.md](LLM_INTEGRATION_DESIGN.md)

---

**æœ€åæ›´æ–°**: 2025-12-12
